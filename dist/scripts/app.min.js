"use strict";var newEventKey;$(document).ready(function(){$("#calendar").fullCalendar({header:{left:"today prev,next",center:"title",right:"timelineDay,timelineThreeDays,agendaWeek,month,listWeek"},eventOverlap:!1,slotEventOverlap:!1,allDay:!0,selectable:!0,selectHelper:!0,defaultView:"month",navLinks:!0,editable:!0,eventLimit:!0,timezone:"America/Chicago",select:function(e,t){console.log(e,t);var i=e.format(),n=t.format(),o=new Date(t).getUTCDate()-1,a="";a=o.toString().length<2?"0"+o.toString():o.toString();var r=n.substr(0,8),s="".concat(r+a);l(i,s)},dayClick:function(e){var t=e.format();l(t,t)},eventClick:function(e,t,i){n(e)},eventRender:function(e,t){if(null!=e.start||null!=e.end)var i="start time: "+e.start.format().slice(11,16)+", end time: "+e.end.format().slice(11,16);else i="n/a";t.addClass(e.description),t.popover({title:e.title,content:i,trigger:"hover",placement:"top",container:"body"})},eventSources:["src/scripts/events.js","src/scripts/settings.js"]});var c=function(e){return e.length<2?"0"+e:e},l=function(s,l){$("#selected").text("selected days: "+s+" to "+l),$("input#title").val(""),$("textarea#info_description").val(""),$("#newEvent").modal("show"),$("#submit").unbind(),$("#submit").on("click",function(){var e,t=$("input#title").val(),i=$("input#stime").val(),n=$("input#etime").val(),o=$("textarea#info_description").val(),a=$("input#newEventLocation").val(),r=firebase.auth().currentUser;null!=r&&(r.displayName,r.email,r.emailVerified,e=r.uid),t?validateEvents(e,{title:t,start:s+"T"+i+":00+01:00",end:l+"T"+n+":00+01:00",description:o,location:a}):alert("please insert a title")})},n=function(v,e,t){console.log(v.start,v.end),$("#editSelected").text("Selected days: "+v.start.format().split("T",1)+" to "+v.end.format().split("T",1)),$("input#editTitle").val(v.title),$("textarea#editinfo_description").val(v.description),$("input#editEventLocation").val(v.location);var i=(v.start._d.getHours()-1).toString(),n=v.start._d.getMinutes().toString(),o=(v.end._d.getHours()-1).toString(),a=v.end._d.getMinutes().toString(),r=c(i),s=c(n),l=c(o),d=c(a);$("input#editstime").val(r+":"+s),$("input#editetime").val(l+":"+d),$("#editEvent").modal("show"),$("#update").unbind(),$("#update").on("click",function(){var e,t=$("input#editTitle").val(),i=$("input#editstime").val(),n=$("input#editetime").val(),o=$("textarea#editinfo_description").val(),a=$("input#editEventLocation").val(),r=firebase.auth().currentUser;null!=r&&(e=r.uid);var s=v.start.format().split("T",1),l=v.end.format().split("T",1),d=s[0],c=l[0];t?(v.description=o,v.title=t,v.start=d+"T"+i+":00+01:00",v.end=c+"T"+n+":00+01:00",validateEvents(e,{title:t,start:d+"T"+i+":00+01:00",end:c+"T"+n+":00+01:00",description:o,location:v.location=a,id:v.id},v)):alert("Title is blank. Try again.")}),$("#delete").on("click",function(){var e,t=firebase.auth().currentUser;null!=t&&(e=t.uid),firebase.database().ref("users/"+e+"/events/"+v.id).set(null),$("#delete").unbind(),eventRenderer(),$("#editEvent").modal("hide")})}});var eventRenderer=function(){$("#calendar").fullCalendar("removeEvents"),events()},getCal1Id=function(e){return"_fc"+(e.replace("_fc","")-1)},disableEnter=function(){$("body").bind("keypress",function(e){if(13==e.keyCode)return e.preventDefault(),!1})};function allEventsOk(e){return 0<e}function validateEvents(e,t,i){var n=Date.parse(t.start);Date.parse(t.end)-n<0&&t.title?alert("event times are invalid. Please correct"):isNotColliding(e,t,i)}function isNotColliding(m,p,g){firebase.database().ref("users/"+m+"/events/").once("value").then(function(e){var t=e.toJSON(),i=new Array,n=new Array,o=moment(p.start).local(),a=moment(p.end).local();for(var r in n.push({startTime:o,endTime:a,location:p.location}),t){var s=t[r],l=moment(s.start),d=moment(s.end);l<a&&o<d?i.push(0):(i.push(1),n.push({startTime:l,endTime:d,location:s.location}))}if(null==p.id&&null==p.id||i.pop(),i.every(allEventsOk)){var c=moment();if(0<=c-o)null==p.id||null==p.id?newEventAdditionProcess(m,p):eventModificationProcess(m,g,p);else{var v=generateNodes(n,c),u={evlocs:v.evlocs,evstimes:v.evstimes,evetimes:v.evetimes};console.log(u);var f=new H.service.Platform({app_id:"SKrth5W6mIRCcxVYfDWi",app_code:"bW5PezhhynKJWF85-sSZlA"});u.evlocs[0]==p.location&&u.evstimes[0]==o?navigator.geolocation.getCurrentPosition(function(e){var t=e.coords;geocodeNext(f,p,g,m,o,a,u,t,c)}):geocodeDef(f,p,g,m,o,a,u)}}else alert("One or more events overlapping. Try changing the time.")})}function generateNodes(e,t){var i=[],n=[],o=[];e.push({startTime:t,endTime:"n/a",location:"NOW"}),e.sort(function(e,t){return e.startTime-t.startTime}),console.log(e);for(var a=0;a<e.length;a++)i.push(e[a].location),n.push(e[a].startTime),o.push(e[a].endTime);return i.splice(0,i.indexOf("NOW")+1),n.splice(0,n.indexOf(t)+1),o.splice(0,o.indexOf("n/a")+1),{evlocs:i,evstimes:n,evetimes:o}}function eventModificationProcess(e,t,i){firebase.database().ref("users/"+e+"/events/"+t.id).set({title:i.title,description:i.description,start:i.start,end:i.end,id:i.id,location:i.location}),$("#calendar").fullCalendar("updateEvent",t),eventRenderer(),$("#editEvent").modal("hide")}function newEventAdditionProcess(e,t){writeNewEvent(e,t.title,t.start,t.end,t.description,t.location),t.id=newEventKey,$("#calendar").fullCalendar("renderEvent",t,!0),eventRenderer(),$("#newEvent").modal("hide")}function errData(e){console.log("ERROR!"+e)}var writeNewEvent=function(e,t,i,n,o,a){var r={title:t,start:i,end:n,description:o,location:a},s=firebase.database().ref().child("events").push().key,l={};return l["/users/"+e+"/events/"+(r.id=s)]=r,firebase.database().ref().update(l),s};function geocodeNext(r,s,l,d,e,t,i,c,n){var o=i.evstimes[i.evstimes.indexOf(e)+1],a=e.diff(n,"seconds");if(null!=o)var v=o.diff(t,"seconds");else v=0;var u={timeGapPre:a,timeGapPost:v},f=i.evlocs[i.evstimes.indexOf(e)+1],m=r.getGeocodingService(),p={searchText:s.location,jsonattributes:1},g={searchText:f,jsonattributes:1};m.geocode(p,function(e){var a=e.response.view[0].result;m.geocode(g,function(e){var t=e.response.view[0].result,i="geo!"+c.latitude.toString()+","+c.longitude.toString(),n="geo!"+a[0].location.displayPosition.latitude.toString()+","+a[0].location.displayPosition.longitude.toString(),o="geo!"+t[0].location.displayPosition.latitude.toString()+","+t[0].location.displayPosition.longitude.toString();console.log(i,n,o),validateWithRoutingTime(r,{routeToEventParams:{mode:"fastest;car",waypoint0:i,waypoint1:n,representation:"display",legAttributes:"travelTime"},routeToNxtEventParams:{mode:"fastest;car",waypoint0:n,waypoint1:o,representation:"display",legAttributes:"travelTime"}},s,d,l,u)},onError)},onError)}function geocodeDef(s,l,d,c,e,t,i){var n=i.evetimes[i.evetimes.indexOf(t)-1],o=i.evstimes[i.evstimes.indexOf(e)],a=i.evetimes[i.evetimes.indexOf(t)],r=i.evstimes[i.evstimes.indexOf(e)+1];if(console.log(i.evetimes,i.evstimes),console.log(o,n),console.log(l.start,l.end),null!=r)var v=r.diff(a,"seconds");else v=0;var u={timeGapPre:o.diff(n,"seconds"),timeGapPost:v},f=i.evlocs[i.evstimes.indexOf(e)-1],m=i.evlocs[i.evstimes.indexOf(e)],p=i.evlocs[i.evstimes.indexOf(e)+1],g={searchText:f,jsonattributes:1},T={searchText:m,jsonattributes:1},h={searchText:p,jsonattributes:1},y=s.getGeocodingService();y.geocode(g,function(e){var r=e.response.view[0].result;y.geocode(T,function(e){var a=e.response.view[0].result;y.geocode(h,function(e){var t=e.response.view[0].result,i="geo!"+r[0].location.displayPosition.latitude.toString()+","+r[0].location.displayPosition.longitude.toString(),n="geo!"+a[0].location.displayPosition.latitude.toString()+","+a[0].location.displayPosition.longitude.toString(),o="geo!"+t[0].location.displayPosition.latitude.toString()+","+t[0].location.displayPosition.longitude.toString();validateWithRoutingTime(s,{routeToEventParams:{mode:"fastest;car",waypoint0:i,waypoint1:n,representation:"display",legAttributes:"travelTime"},routeToNxtEventParams:{mode:"fastest;car",waypoint0:n,waypoint1:o,representation:"display",legAttributes:"travelTime"}},l,c,d,u)},onError)},onError)},onError)}function validateWithRoutingTime(e,t,n,o,a,r){var s=e.getRoutingService();s.calculateRoute(t.routeToEventParams,function(e){var i=e.response.route[0].leg[0].travelTime;s.calculateRoute(t.routeToNxtEventParams,function(e){var t=e.response.route[0].leg[0].travelTime;console.log(i,t,r),r.timeGapPre+300>i&&r.timeGapPost+300>t?null==n.id||null==n.id?newEventAdditionProcess(o,n):eventModificationProcess(o,a,n):alert("ERROR: you're either short on time to get there or you'd be unable to get to the following appointment!")},function(e){alert(e.message)})},function(e){alert(e.message)})}function onError(e){alert(e+": geocoding service error")}