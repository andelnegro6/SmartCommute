"use strict";var newEventKey;$(document).ready(function(){$("#calendar").fullCalendar({header:{left:"today prev,next",center:"title",right:"timelineDay,timelineThreeDays,agendaWeek,month,listWeek"},eventOverlap:!1,slotEventOverlap:!1,allDay:!0,selectable:!0,selectHelper:!0,defaultView:"month",navLinks:!0,editable:!0,eventLimit:!0,timezone:"America/Chicago",select:function(e,t){var n=e.format(),i=t.format(),o=new Date(t).getUTCDate()-1,a="";a=o.toString().length<2?"0"+o.toString():o.toString();var r=i.substr(0,8),s="".concat(r+a);l(n,s)},dayClick:function(e){new Date(e);var t=e.format();l(t,t)},eventClick:function(e,t,n){i(e)},eventRender:function(e,t){if(null!=e.start||null!=e.end)var n="start time: "+e.start.format().slice(11,16)+", end time: "+e.end.format().slice(11,16);else n="n/a";t.addClass(e.description),t.popover({title:e.title,content:n,trigger:"hover",placement:"top",container:"body"})},eventSources:["src/scripts/events.js","src/scripts/settings.js"]});var c=function(e){return e.length<2?"0"+e:e},l=function(v,u){$("#selected").text("selected days: "+v+" to "+u),$("input#title").val(""),$("textarea#info_description").val(""),$("#newEvent").modal("show"),$("#submit").unbind(),$("#submit").on("click",function(){var e,t=$("input#title").val(),n=$("input#stime").val(),i=$("input#etime").val(),o=$("textarea#info_description").val(),a=$("input#newEventLocation").val(),r=firebase.auth().currentUser;null!=r&&(r.displayName,r.email,r.emailVerified,e=r.uid);var s=v+"T"+n+":00.000Z",l=u+"T"+i+":00.000Z",d=Date.parse(s),c=Date.parse(l);t?validateEvents(e,d,c,{title:t,start:v+"T"+n+":00.000Z",end:u+"T"+i+":00.000Z",description:o,location:a}):alert("please insert a title")})},i=function(m,e,t){console.log(m.start,m.end),$("#editSelected").text("Selected days: "+m.start.format().split("T",1)+" to "+m.end.format().split("T",1)),$("input#editTitle").val(m.title),$("textarea#editinfo_description").val(m.description),$("input#editEventLocation").val(m.location);var n=(m.start._d.getHours()-1).toString(),i=m.start._d.getMinutes().toString(),o=(m.end._d.getHours()-1).toString(),a=m.end._d.getMinutes().toString(),r=c(n),s=c(i),l=c(o),d=c(a);$("input#editstime").val(r+":"+s),$("input#editetime").val(l+":"+d),$("#editEvent").modal("show"),$("#update").unbind(),$("#update").on("click",function(){var e,t=$("input#editTitle").val(),n=$("input#editstime").val(),i=$("input#editetime").val(),o=$("textarea#editinfo_description").val(),a=$("input#editEventLocation").val(),r=firebase.auth().currentUser;null!=r&&(e=r.uid);var s=m.start.format().split("T",1),l=m.end.format().split("T",1),d=s[0],c=l[0],v=d+" "+n+" Z",u=c+" "+i+" Z",f=Date.parse(v),p=Date.parse(u);t?(m.description=o,m.title=t,m.start=d+"T"+n+":00.000Z",m.end=c+"T"+i+":00.000Z",validateEvents(e,f,p,{title:t,start:d+"T"+n+":00.000Z",end:c+"T"+i+":00.000Z",description:o,location:m.location=a,id:m.id},m)):alert("Title is blank. Try again.")}),$("#delete").on("click",function(){var e,t=firebase.auth().currentUser;null!=t&&(e=t.uid),firebase.database().ref("users/"+e+"/events/"+m.id).set(null),$("#delete").unbind(),eventRenderer(),$("#editEvent").modal("hide")})}});var eventRenderer=function(){$("#calendar").fullCalendar("removeEvents"),events()},getCal1Id=function(e){return"_fc"+(e.replace("_fc","")-1)},disableEnter=function(){$("body").bind("keypress",function(e){if(13==e.keyCode)return e.preventDefault(),!1})};function allEventsOk(e){return 0<e}function validateEvents(e,t,n,i,o){n-t<0&&i.title?alert("event times are invalid. Please correct"):isNotColliding(e,t,n,i,o)}function isNotColliding(h,T,$,y,b){firebase.database().ref("users/"+h+"/events/").once("value").then(function(e){var t=e.toJSON(),n=new Array,i=new Array,o=moment(T),a=moment($);for(var r in i.push({startTime:o,endTime:a,location:y.location}),t){var s=t[r],l=moment(s.start),d=moment(s.end);l<$&&T<d?n.push(0):(n.push(1),i.push({startTime:l,endTime:d,location:s.location}))}if(null==y.id&&null==y.id||n.pop(),n.every(allEventsOk)){var c=moment();if(0<=c-T)null==y.id||null==y.id?newEventAdditionProcess(h,y):eventModificationProcess(h,b,y);else{var v=generateNodes(i,c),u=v.evlocs,f=v.evstimes,p=v.evetimes,m={evlocs:u,evstimes:f,evetimes:p};console.log(u,f,p);var g=new H.service.Platform({app_id:"SKrth5W6mIRCcxVYfDWi",app_code:"bW5PezhhynKJWF85-sSZlA"});u[0]==y.location?navigator.geolocation.getCurrentPosition(function(e){var t=e.coords;geocodeNext(g,y,b,t,c,h,o)}):geocodeDef(g,m,y,b,h,o)}}else alert("One or more events overlapping. Try changing the time.")})}function generateNodes(e,t){var n=[],i=[],o=[];e.push({startTime:t,endTime:"n/a",location:"NOW"}),e.sort(function(e,t){return e.startTime-t.startTime}),console.log(e);for(var a=0;a<e.length;a++)n.push(e[a].location),i.push(e[a].startTime),o.push(e[a].endTime);return n.splice(0,n.indexOf("NOW")+1),i.splice(0,i.indexOf(t)+1),o.splice(0,o.indexOf("n/a")+1),{evlocs:n,evstimes:i,evetimes:o}}function eventModificationProcess(e,t,n){firebase.database().ref("users/"+e+"/events/"+t.id).set({title:n.title,description:n.description,start:n.start,end:n.end,id:n.id,location:n.location}),$("#calendar").fullCalendar("updateEvent",t),eventRenderer(),$("#editEvent").modal("hide")}function newEventAdditionProcess(e,t){writeNewEvent(e,t.title,t.start,t.end,t.description,t.location),t.id=newEventKey,$("#calendar").fullCalendar("renderEvent",t,!0),eventRenderer(),$("#newEvent").modal("hide")}function errData(e){console.log("ERROR!"+e)}var writeNewEvent=function(e,t,n,i,o,a){var r={title:t,start:n,end:i,description:o,location:a},s=firebase.database().ref().child("events").push().key,l={};return l["/users/"+e+"/events/"+(r.id=s)]=r,firebase.database().ref().update(l),s};function geocodeNext(s,l,d,c,v,u,f){var e=s.getGeocodingService(),t={searchText:l.location,jsonattributes:1};e.geocode(t,function(e){var t=e.response.view[0].result,n="geo!"+c.latitude.toString()+","+c.longitude.toString(),i="geo!"+t[0].location.displayPosition.latitude.toString()+","+t[0].location.displayPosition.longitude.toString();console.log(n,i);var o={mode:"fastest;car",waypoint0:n,waypoint1:i,representation:"display",legAttributes:"travelTime"},a=s.getRoutingService(),r=f.diff(v,"seconds");validateWithRoutingTime(a,o,f,v,l,u,d,r)},onError)}function geocodeDef(a,e,r,s,l,d){var t=moment(e.evetimes[evetimes.indexOf(r.end)-1]),c=moment(e.evetimes[evetimes.indexOf(r.start)]).diff(t,"seconds"),n={searchText:e.evlocs[evlocs.indexOf(r.location)-1],jsonattributes:1},i={searchText:e.evlocs[evlocs.indexOf(r.location)],jsonattributes:1},v=a.getGeocodingService();v.geocode(n,function(e){var t=e.response.view[0].result,o="geo!"+t[0].location.displayPosition.latitude.toString()+","+t[0].location.displayPosition.longitude.toString();v.geocode(i,function(e){var t=e.response.view[0].result,n="geo!"+t[0].location.displayPosition.latitude.toString()+","+t[0].location.displayPosition.longitude.toString(),i={mode:"fastest;car",waypoint0:o,waypoint1:n,representation:"display",legAttributes:"travelTime"};validateWithRoutingTime(a.getRoutingService(),i,d,0,r,l,s,c)},onError)},onError)}function validateWithRoutingTime(e,t,n,i,o,a,r,s){e.calculateRoute(t,function(e){var t=e.response.route[0].leg[0].travelTime;console.log(t,n,i,s),t<s+300-3600?null==o.id||null==o.id?newEventAdditionProcess(a,o):eventModificationProcess(a,r,o):alert("ERROR: you don't have enough time to get there!")},function(e){alert(e.message)})}function onError(e){alert(e+": geocoding service error")}