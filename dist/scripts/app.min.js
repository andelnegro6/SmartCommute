"use strict";var newEventKey;$(document).ready(function(){$("#calendar").fullCalendar({header:{left:"today prev,next",center:"title",right:"timelineDay,timelineThreeDays,agendaWeek,month,listWeek"},eventOverlap:!1,slotEventOverlap:!1,allDay:!0,selectable:!0,selectHelper:!0,defaultView:"month",navLinks:!0,editable:!0,eventLimit:!0,timezone:"America/Chicago",select:function(e,t){var n=e.format(),i=t.format(),a=new Date(t).getUTCDate()-1,r="";r=a.toString().length<2?"0"+a.toString():a.toString();var l=i.substr(0,8),s="".concat(l+r);d(n,s)},dayClick:function(e){new Date(e);var t=e.format();d(t,t)},eventClick:function(e,t,n){i(e)},eventRender:function(e,t){var n=e.start.format().slice(11,16),i=e.end.format().slice(11,16);t.addClass(e.description),t.popover({title:e.title,content:"start time: "+n+", end time: "+i,trigger:"hover",placement:"top",container:"body"})},eventSources:["src/scripts/events.js","src/scripts/settings.js"]});var u=function(e){return e.length<2?"0"+e:e},d=function(u,c){$("#selected").text("selected days: "+u+" to "+c),$("input#title").val(""),$("textarea#info_description").val(""),$("#newEvent").modal("show"),$("#submit").unbind(),$("#submit").on("click",function(){var e,t=$("input#title").val(),n=$("input#stime").val(),i=$("input#etime").val(),a=$("textarea#info_description").val(),r=firebase.auth().currentUser;null!=r&&(r.displayName,r.email,r.emailVerified,e=r.uid);var l=u+" "+n+" Z",s=c+" "+i+" Z",d=Date.parse(l),o=Date.parse(s);t?validateEvents(e,d,o,{title:t,start:u+"T"+n+":00.000Z",end:c+"T"+i+":00.000Z",description:a}):alert("please insert a title")})},i=function(p,e,t){console.log(p.start,p.end),$("#editSelected").text("Selected days: "+p.start.format().split("T",1)+" to "+p.end.format().split("T",1)),$("input#editTitle").val(p.title),$("textarea#editinfo_description").val(p.description);var n=(p.start._d.getHours()-1).toString(),i=p.start._d.getMinutes().toString(),a=(p.end._d.getHours()-1).toString(),r=p.end._d.getMinutes().toString(),l=u(n),s=u(i),d=u(a),o=u(r);$("input#editstime").val(l+":"+s),$("input#editetime").val(d+":"+o),$("#editEvent").modal("show"),$("#update").unbind(),$("#update").on("click",function(){var e,t=$("input#editTitle").val(),n=$("input#editstime").val(),i=$("input#editetime").val(),a=$("textarea#editinfo_description").val(),r=firebase.auth().currentUser;null!=r&&(r.displayName,r.email,r.emailVerified,e=r.uid);var l=p.start.format().split("T",1),s=p.end.format().split("T",1),d=l[0],o=s[0],u=d+" "+n+" Z",c=o+" "+i+" Z",v=Date.parse(u),f=Date.parse(c);t?(p.description=a,p.title=t,p.start=d+"T"+n+":00.000Z",p.end=o+"T"+i+":00.000Z",validateEvents(e,v,f,{title:t,start:d+"T"+n+":00.000Z",end:o+"T"+i+":00.000Z",description:a,id:p.id},p)):alert("Title is blank. Try again.")}),$("#delete").on("click",function(){var e,t=firebase.auth().currentUser;null!=t&&(e=t.uid),firebase.database().ref("users/"+e+"/events/"+p.id).set(null),$("#delete").unbind(),eventRenderer(),$("#editEvent").modal("hide")})}});var eventRenderer=function(){$("#calendar").fullCalendar("removeEvents"),events()},getCal1Id=function(e){return"_fc"+(e.replace("_fc","")-1)},disableEnter=function(){$("body").bind("keypress",function(e){if(13==e.keyCode)return e.preventDefault(),!1})};function allEventsOk(e){return 0<e}function validateEvents(e,t,n,i,a){n-t<0&&i.title?alert("event times are invalid. Please correct"):isNotColliding(e,t,n,i,a)}function isNotColliding(s,d,o,u,c){firebase.database().ref("users/"+s+"/events/").once("value").then(function(e){var t=e.toJSON(),n=new Array;for(var i in t){var a=t[i],r=Date.parse(a.start),l=Date.parse(a.end);r<o&&d<l?n.push(0):n.push(1)}null==u.id&&null==u.id||n.pop(),n.every(allEventsOk)?null==u.id||null==u.id?(writeNewEvent(s,u.title,u.start,u.end,u.description),u.id=newEventKey,$("#calendar").fullCalendar("renderEvent",u,!0),eventRenderer(),$("#newEvent").modal("hide")):(firebase.database().ref("users/"+s+"/events/"+c.id).set({title:u.title,description:u.description,start:u.start,end:u.end,id:u.id}),$("#calendar").fullCalendar("updateEvent",c),eventRenderer(),$("#editEvent").modal("hide")):alert("One or more events overlapping. Try changing the time.")})}function errData(e){console.log("ERROR!"+e)}var writeNewEvent=function(e,t,n,i,a){var r={title:t,start:n,end:i,description:a},l=firebase.database().ref().child("events").push().key,s={};return s["/users/"+e+"/events/"+(r.id=l)]=r,firebase.database().ref().update(s),l};