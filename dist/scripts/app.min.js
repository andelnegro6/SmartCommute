"use strict";var newEventKey;$(document).ready(function(){$("#calendar").fullCalendar({header:{left:"today prev,next",center:"title",right:"timelineDay,timelineThreeDays,agendaWeek,month,listWeek"},eventOverlap:!1,slotEventOverlap:!1,allDay:!0,selectable:!0,selectHelper:!0,defaultView:"month",navLinks:!0,editable:!0,eventLimit:!0,timezone:"America/Chicago",select:function(e,t){var n=e.format(),i=t.format(),a=new Date(t).getUTCDate()-1,r="";r=a.toString().length<2?"0"+a.toString():a.toString();var o=i.substr(0,8),l="".concat(o+r);s(n,l)},dayClick:function(e){new Date(e);var t=e.format();s(t,t)},eventClick:function(e,t,n){i(e)},eventRender:function(e,t){if(null!=e.start||null!=e.end)var n="start time: "+e.start.format().slice(11,16)+", end time: "+e.end.format().slice(11,16);else n="n/a";t.addClass(e.description),t.popover({title:e.title,content:n,trigger:"hover",placement:"top",container:"body"})},eventSources:["src/scripts/events.js","src/scripts/settings.js"]});var c=function(e){return e.length<2?"0"+e:e},s=function(u,v){$("#selected").text("selected days: "+u+" to "+v),$("input#title").val(""),$("textarea#info_description").val(""),$("#newEvent").modal("show"),$("#submit").unbind(),$("#submit").on("click",function(){var e,t=$("input#title").val(),n=$("input#stime").val(),i=$("input#etime").val(),a=$("textarea#info_description").val(),r=$("input#newEventLocation").val(),o=firebase.auth().currentUser;null!=o&&(o.displayName,o.email,o.emailVerified,e=o.uid);var l=u+"T"+n+":00.000Z",s=v+"T"+i+":00.000Z",d=Date.parse(l),c=Date.parse(s);t?validateEvents(e,d,c,{title:t,start:u+"T"+n+":00.000Z",end:v+"T"+i+":00.000Z",description:a,location:r}):alert("please insert a title")})},i=function(m,e,t){console.log(m.start,m.end),$("#editSelected").text("Selected days: "+m.start.format().split("T",1)+" to "+m.end.format().split("T",1)),$("input#editTitle").val(m.title),$("textarea#editinfo_description").val(m.description),$("input#editEventLocation").val(m.location);var n=(m.start._d.getHours()-1).toString(),i=m.start._d.getMinutes().toString(),a=(m.end._d.getHours()-1).toString(),r=m.end._d.getMinutes().toString(),o=c(n),l=c(i),s=c(a),d=c(r);$("input#editstime").val(o+":"+l),$("input#editetime").val(s+":"+d),$("#editEvent").modal("show"),$("#update").unbind(),$("#update").on("click",function(){var e,t=$("input#editTitle").val(),n=$("input#editstime").val(),i=$("input#editetime").val(),a=$("textarea#editinfo_description").val(),r=$("input#editEventLocation").val(),o=firebase.auth().currentUser;null!=o&&(o.displayName,o.email,o.emailVerified,e=o.uid);var l=m.start.format().split("T",1),s=m.end.format().split("T",1),d=l[0],c=s[0],u=d+" "+n+" Z",v=c+" "+i+" Z",f=Date.parse(u),p=Date.parse(v);t?(m.description=a,m.title=t,m.start=d+"T"+n+":00.000Z",m.end=c+"T"+i+":00.000Z",validateEvents(e,f,p,{title:t,start:d+"T"+n+":00.000Z",end:c+"T"+i+":00.000Z",description:a,location:m.location=r,id:m.id},m)):alert("Title is blank. Try again.")}),$("#delete").on("click",function(){var e,t=firebase.auth().currentUser;null!=t&&(e=t.uid),firebase.database().ref("users/"+e+"/events/"+m.id).set(null),$("#delete").unbind(),eventRenderer(),$("#editEvent").modal("hide")})}});var eventRenderer=function(){$("#calendar").fullCalendar("removeEvents"),events()},getCal1Id=function(e){return"_fc"+(e.replace("_fc","")-1)},disableEnter=function(){$("body").bind("keypress",function(e){if(13==e.keyCode)return e.preventDefault(),!1})};function allEventsOk(e){return 0<e}function validateEvents(e,t,n,i,a){n-t<0&&i.title?alert("event times are invalid. Please correct"):isNotColliding(e,t,n,i,a)}function isNotColliding($,h,T,b,E){firebase.database().ref("users/"+$+"/events/").once("value").then(function(e){var t=e.toJSON(),n=new Array,i=new Array,a=moment(h),r=moment(T);for(var o in i.push({startTime:a,endTime:r,location:b.location}),t){var l=t[o],s=moment(l.start),d=moment(l.end);s<T&&h<d?n.push(0):(n.push(1),i.push({startTime:s,endTime:d,location:l.location}))}if(null==b.id&&null==b.id||n.pop(),n.every(allEventsOk)){var c=moment();if(0<=c-h)null==b.id||null==b.id?newEventAdditionProcess($,b):eventModificationProcess($,E,b);else{var u=[],v=[],f=[];i.push({startTime:c,endTime:"n/a",location:"NOW"}),i.sort(function(e,t){return e.startTime-t.startTime}),console.log(i);for(var p=0;p<i.length;p++)u.push(i[p].location),v.push(i[p].startTime),f.push(i[p].endTime);u.splice(0,u.indexOf("NOW")+1),v.splice(0,v.indexOf(c)+1),f.splice(0,f.indexOf("n/a")+1),console.log(u,v,f);var m=u[u.indexOf(b.location)],g=u[u.indexOf(b.location)+1];geocode(platform,b,m,g)}}else alert("One or more events overlapping. Try changing the time.")})}function eventModificationProcess(e,t,n){firebase.database().ref("users/"+e+"/events/"+t.id).set({title:n.title,description:n.description,start:n.start,end:n.end,id:n.id,location:n.location}),$("#calendar").fullCalendar("updateEvent",t),eventRenderer(),$("#editEvent").modal("hide")}function newEventAdditionProcess(e,t){writeNewEvent(e,t.title,t.start,t.end,t.description,t.location),t.id=newEventKey,$("#calendar").fullCalendar("renderEvent",t,!0),eventRenderer(),$("#newEvent").modal("hide")}function errData(e){console.log("ERROR!"+e)}var writeNewEvent=function(e,t,n,i,a,r){var o={title:t,start:n,end:i,description:a,location:r},l=firebase.database().ref().child("events").push().key,s={};return s["/users/"+e+"/events/"+(o.id=l)]=o,firebase.database().ref().update(s),l};function geocode(e,t,n,i){var a=e.getGeocodingService(),r={searchText:t.location,jsonattributes:1};a.geocode(r,onSuccess,onError)}function onSuccess(e){e.response.view[0].result}function onError(e){alert("Ooops!")}